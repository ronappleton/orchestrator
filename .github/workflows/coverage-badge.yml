name: Coverage Badge

on:
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
      - name: Run Tests With Coverage
        run: go test ./... -coverprofile=coverage.out
      - name: Generate Coverage Badge
        run: |
          python - <<'PY'
          import re
          from pathlib import Path
          import subprocess

          out = subprocess.check_output(['go','tool','cover','-func=coverage.out'], text=True)
          m = re.findall(r'total:\s+\(statements\)\s+([0-9.]+)%', out)
          pct = float(m[-1]) if m else 0.0

          if pct >= 80:
              color = '#4c1'
          elif pct >= 70:
              color = '#97CA00'
          elif pct >= 60:
              color = '#dfb317'
          else:
              color = '#e05d44'

          label = 'coverage'
          value = f"{pct:.1f}%"

          svg = (
              "<svg xmlns='http://www.w3.org/2000/svg' width='120' height='20'>"
              "<linearGradient id='b' x2='0' y2='100%'>"
              "<stop offset='0' stop-color='#bbb' stop-opacity='.1'/>"
              "<stop offset='1' stop-opacity='.1'/>"
              "</linearGradient>"
              "<mask id='a'>"
              "<rect width='120' height='20' rx='3' fill='#fff'/>"
              "</mask>"
              "<g mask='url(#a)'>"
              "<rect width='60' height='20' fill='#555'/>"
              "<rect x='60' width='60' height='20' fill='" + color + "'/>"
              "<rect width='120' height='20' fill='url(#b)'/>"
              "</g>"
              "<g fill='#fff' text-anchor='middle' font-family='Verdana,DejaVu Sans,sans-serif' font-size='11'>"
              "<text x='30' y='14'>" + label + "</text>"
              "<text x='90' y='14'>" + value + "</text>"
              "</g>"
              "</svg>"
          )

          out_dir = Path('docs/badges')
          out_dir.mkdir(parents=True, exist_ok=True)
          (out_dir / 'coverage.svg').write_text(svg)
          PY
      - name: Commit Coverage Badge
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
        run: |
          if git status --porcelain docs/badges/coverage.svg | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add docs/badges/coverage.svg
            git commit -m "chore: update coverage badge"
            git push
          else
            echo "No coverage badge changes."
          fi
